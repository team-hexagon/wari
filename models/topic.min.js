(function(){var f,t,i,n,u,e,r;r=require("mongoose"),f=require("eventproxy"),i=r.Schema,t=i.ObjectId,e=console.log,u=new i({title:{type:String,required:!0},content:{type:String,required:!0},_author:{type:t,ref:"User",required:!0},_tag:{type:t,ref:"Tag",required:!0},top:{type:Boolean,"default":!1},reply_count:{type:Number,"default":0},visit_count:{type:Number,"default":0},collect_count:{type:Number,"default":0},create_at:{type:Date,"default":Date.now},update_at:{type:Date,"default":Date.now},_last_reply:{type:t,ref:"Reply"},last_reply_at:{type:Date,"default":Date.now},content_is_html:{type:Boolean}}),n=r.model("Topic",u),n.getTopicById=function(t){return n.findOne({_id:t}).populate("_author").populate("_last_reply").exec(function(n,t){return n?callback(n):t?TopicTag.find({_topic:t._id}).populate("_topic".exec(function(n,i){return callback(null,t,i)})):callback(null,null,[])})},n.updateLastReply=function(t,i,r){return n.findOne({_id:t},function(n,t){return n?r(n):(t._last_reply=i,t.last_reply_at=new Date,t.reply_count+=1,t.save(r))})},n.reduceReply=function(t,i){return n.findOne({_id:t},function(n,t){return error?i(error):t?(t.reply_count-=1,t.save(i)):i(new Error("No Reply"))})},module.exports=n}).call(this)