(function(){var r,n,f,e,i,h,t,o,u,s;s=require("validator"),r=require("eventproxy"),o=console.log,u=s.sanitize,e=models.Topic,n=models.Tag,f=models.TagCollect,i=models.TopicTag,h=models.User,t=function(n){return u(u(n).trim()).xss()},exports.listTopic=function(t,u,f){var o,s,h;return h=t.param("name"),s=t.param("page"),s=s||1,o=config.listTopicCount,n.getTagByName(h,function(n,t){var c,l,h,a;return n?f(n):t?(a=t.background?"#wrapper {background-image: url('"+t.background+"')}":null,c=function(n,i,r,f,e){return u.render(""+t.menu_template+"/index",{tag:t,topics:i,currentPage:s,listTopicCount:o,inCollection:r,hotTopics:f,noReplyTopics:e,pages:n,extraStyle:a})},h=new r,l=["pages","topics"],h.assign(l,c),i.count({_tag:t._id},function(n,t){var i;return i=Math.ceil(t/o),h.emit("pages",i)}),i.find({_tag:t._id},null,{skip:(s-1)*o,limit:o,sort:[["create_at","desc"]]},function(n,t){var i;return i=e.find({_id:{$in:t.map(function(n){return n._topic})}}),i.sort({create_at:"desc"}),i.populate("_author","login").populate("_tag","name").exec(h.done("topics"))})):u.render("notify/notify",{error:"no exists tag"})})},exports.editTags=function(t,i){return n.getAllTags(function(n,t){return i.render("tags/editAll",{tags:t})})},exports.add=function(i,r,u){var e,o,s,f,h;f=i.param("name"),f=t(f),o=i.param("description"),o=t(o),s=i.param("menu-template"),s=t(s),h=i.param("order"),e=i.param("ancestors");try{e=JSON.parse(e)}catch(c){e=[]}return f?n.getTagByName(f,function(t,i){var c;return t?u(t):i&&i.length>0?r.render("notify/notify",{error:"이미 있엉"}):(c=new n({name:f,menu_template:s,order:h,description:o,ancestors:e}),c.save(function(n){return n?u(n):r.redirect("/tags/edit")}))}):r.render("notify/notify",{error:"이름이 없엉"})},exports.edit=function(t,i,r){var u;return u=t.param("name"),n.getTagByName(u,function(t,u){return t?r(t):u?n.getAllTags(function(n,t){return n?r(n):i.render("tags/edit",{tag:u,tags:t})}):i.render("notify/notify",{error:"존재하지 않는 태그입니다."})})},exports.update=function(i,r,u){var f;return f=i.param("id"),n.getTagById(f,function(n,f){var e,h,c,s,l;if(n)return u(n);if(!f)return r.render("notify/notify",{error:"존재하지 않는 태그입니다."});s=i.param("name"),s=t(s),l=i.param("order"),c=i.param("menu-template"),c=t(c),h=i.param("description"),h=t(h),e=i.param("ancestors");try{e=JSON.parse(e)}catch(a){e=[]}return s?(f.name=s,f.order=l,f.menu_template=c,f.description=h,f.ancestors=e,f.save(function(n){return n?u(n):(r.redirect("/tags/edit"),o(f))})):r.send("notify/notify",{error:"이름이 이상해요"})})},exports.del=function(t,u,e){var s,o,h;return h=t.param("name"),n.getTagByName(h,function(n,t){return n?e(n):t?void 0:u.render("notify/notify",{error:"존재하지 않는 태그입니다."})}),o=new r,s=function(){return tag.remove(function(n){return n?e(n):u.redirect("/")})},o.assign("topicTagRemoved","tagCollectRemoved",s),o.fail(e),i.removeByTagId(tag._id,o.done("topicTagRemoved")),f.removeAllByTagId(tag._id,o.done("tagCollectRemoved"))},exports.collect=function(){},exports.decollect=function(){}}).call(this)