(function(){var i,o,t,n,s,u,f,h,r,e;e=require("validator"),i=require("eventproxy"),h=require("moment"),r=e.sanitize,f=models.User,n=models.Topic,t=models.Tag,o=models.Ralation,u=models.TopicTag,s=models.TopicCollect,exports.index=function(t,r,u){var f,e;return e=t.param("tid"),e.length!==24&&r.render("notify/notify",{error:"non valid tag"}),f=n.findOne({_id:e}),f.populate("_tag"),f.populate("_author"),f.exec(function(t,f){var o,e;return f?t?(e.unbind(),r.render("notify/notify",{error:t})):(o=["otherTopics","noReplyTopics"],e=i.create(o,function(){return r.render(""+f._tag.menu_template+"/topic",{topic:f})}),e.fail(u),n.find({author_id:f.author_id,_id:{$nin:[f._id]}},null,{limit:5,sort:[["last_reply_at","desc"]]},e.done("otherTopics")),n.find({reply_count:0},null,{limit:5,sort:[["created_at","desc"]]},e.done("noReplyTopics"))):u(t)})},exports.create=function(n,i,r){var u;return u=n.param("tagName"),t.findOne({name:u},{},{sort:[["order","asc"]]},function(n,t){return(log(t),n)?r(n):i.render("topic/edit",{tag:t})})},exports.put=function(e,o,s){var c,l,h;return l=e.param("tagName"),h=e.param("title"),h=r(h).trim(),h=r(h).xss(),c=e.param("content"),t.getTagByName(l,function(r,l){var a;return r?s(r):(log(l),l.ancestors.push(l._id),log(e.user),a=new n({title:h,content:c,_author:e.user._id,_tag:l._id}),a.save(function(n){var r;return n?s(n):(r=new i,r.assign(["tagSave","scoreSave"],function(){return o.redirect("/topic/"+a._id)}),r.fail(s),r.after("tagSave",l.ancestors.length,function(){return r.emit("tagSave")}),l.ancestors.forEach(function(n){var i;return i=new u({_topic:a._id,_tag:n}),i.save(r.done("tagSave")),t.findById(n,r.done(function(n){return n.topic_count+=1,n.save()}))}),f.findById(e.user._id,r.done(function(n){return n.score+=5,n.topic_count+=1,e.user.score+=5,n.save(r.done("scoreSave"))})))}))})},exports.showEdit=function(){},exports.update=function(){},exports.del=function(){},exports.top=function(){},exports.collect=function(t,i,r){var f,u;return f=t.param("tagName"),u=t.param("topic-id"),n.findById(u,function(n,t){return n?r(n):t?void 0:i.send({error:"no topic"})})},exports.decollect=function(){}}).call(this)