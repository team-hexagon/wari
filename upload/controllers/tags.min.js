(function(){var r,t,u,f,i,s,e,n,o;o=require("validator"),r=require("eventproxy"),e=console.log,n=o.sanitize,f=models.Topic,t=models.Tag,u=models.TagCollect,i=models.TopicTag,s=models.User,exports.listTopic=function(n,u,e){var o,s,h;return h=n.param("name"),s=n.param("page"),s=s||1,o=config.listTopicCount,t.getTagByName(h,function(n,t){var c,l,h,a;return n?e(n):t?(a=t.background?"#wrapper {background-image: url('"+t.background+"')}":null,c=function(n,i,r,f,e){return u.render(""+t.menu_template+"/index",{tag:t,topics:i,currentPage:s,listTopicCount:o,inCollection:r,hotTopics:f,noReplyTopics:e,pages:n,extraStyle:a})},h=new r,l=["pages","topics"],h.assign(l,c),i.count({_tag:t._id},function(n,t){var i;return i=Math.ceil(t/o),h.emit("pages",i)}),i.find({_tag:t._id},null,{skip:(s-1)*o,limit:o,sort:[["create_at","desc"]]},function(n,t){var i;return i=f.find({_id:{$in:t.map(function(n){return n._topic})}}),i.sort({create_at:"desc"}),i.populate("_author","login").populate("_tag","name").exec(h.done("topics"))})):u.render("notify/notify",{error:"no exists tag"})})},exports.editTags=function(n,i){return t.getAllTags(function(n,t){return i.render("tags/editAll",{tags:t})})},exports.add=function(i,r,u){var e,o,f,s;return(f=i.param("name"),f=n(f).trim(),f=n(f).xss(),e=i.param("description"),e=n(e).trim(),e=n(e).xss(),o=i.param("menu-template"),o=n(o).trim(),o=n(o).xss(),s=i.param("order"),!f)?r.render("notify/notify",{error:"이름이 없엉"}):t.getTagByName(f,function(n,i){var h;return n?u(n):i&&i.length>0?r.render("notify/notify",{error:"이미 있엉"}):(h=new t({name:f,menu_template:o,order:s,description:e}),h.save(function(n){return n?u(n):r.redirect("/tags/edit")}))})},exports.edit=function(n,i,r){var u;return u=n.param("name"),t.getTagByName(u,function(n,u){return n?r(n):u?t.getAllTags(function(n,t){return n?r(n):i.render("tags/edit",{tag:u,tags:t})}):i.render("notify/notify",{error:"존재하지 않는 태그입니다."})})},exports.update=function(i,r,u){var f;return f=i.param("id"),t.getTagById(f,function(t,f){var s,h,o,c;return t?u(t):f?(o=i.param("name"),o=n(o).trim(),o=n(o).xss(),c=i.param("order"),h=i.param("menu-template"),h=n(h).trim(),h=n(h).xss(),s=i.param("description"),s=n(s).trim(),s=n(s).xss(),!o)?r.send("notify/notify",{error:"이름이 이상해요"}):(f.name=o,f.order=c,f.menu_template=h,f.description=s,f.save(function(n){return n?u(n):(r.redirect("/tags/edit"),e(f))})):r.render("notify/notify",{error:"존재하지 않는 태그입니다."})})},exports.del=function(n,f,e){var s,o,h;return h=n.param("name"),t.getTagByName(h,function(n,t){return n?e(n):t?void 0:f.render("notify/notify",{error:"존재하지 않는 태그입니다."})}),o=new r,s=function(){return tag.remove(function(n){return n?e(n):f.redirect("/")})},o.assign("topicTagRemoved","tagCollectRemoved",s),o.fail(e),i.removeByTagId(tag._id,o.done("topicTagRemoved")),u.removeAllByTagId(tag._id,o.done("tagCollectRemoved"))},exports.collect=function(){},exports.decollect=function(){}}).call(this)