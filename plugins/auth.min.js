(function(){var n,r,u,f,s,t,c,e,h,i,o;u=require("../config"),t=require("everyauth"),s=require("crypto"),o=require("validator"),h=require("../models"),e=console.log,i=o.sanitize,r=o.check,n=h.User,f=function(n){var t;return t=s.createHash("sha1"),t.update(n),t.digest("hex")},c=module.exports=function(){var o;return t.facebook.entryPath("/auth/facebook").appId(u.oauth.facebook.appId).appSecret(u.oauth.facebook.appSecret).handleAuthCallbackError(function(){return e("error")}).findOrCreateUser(function(t,i,r,u){var f;return f=this.Promise(null),n.getUserByLogin(u.id,function(t,i){return t?f.fulfill([t]):i?f.fulfill(i):n.insert({name:u.username,login:u.id,password:"facebook"},function(n,t){return f.fulfill(t)})}),f}).redirectPath("/"),o=t.password.loginWith("login"),t.everymodule.userPkey("_id"),t.everymodule.findUserById(function(t,i){return n.findById(t,i)}),t.everymodule.logoutPath("/logout"),t.everymodule.logoutRedirectPath("/"),o.registerView("auth/register"),o.getRegisterPath("/register"),o.postRegisterPath("/register"),o.extractExtraRegistrationParams(function(n){return{passwordConfirm:n.param("password-confirm"),email:n.param("email")}}),o.validateRegistration(function(t,u){var o,s,f,h,c,l;if(l=this.Promise(null),e(t),f=i(t.login).xss(),s=f.toLowerCase(),h=i(t.password).trim(),h=i(h).xss(),c=i(t.passwordConfirm).trim(),c=i(c).xss(),o=i(t.email.toLowerCase()).xss(),f===""&&h===""&&c==="")return[{error:"오류",login:s}];if(f.length<5)return[{error:"오류",login:s}];try{r(f,"0-9, a-z, A-Z").isAlphanumeric()}catch(a){return[{error:a.message,name:f}]}try{r(o,"이메일 형식이 아닙니다.").isEmail()}catch(a){return[{error:a.message,email:o}]}return t.passwordConfirm?(n.findOne({$or:[{login:s},{email:o}]},function(n,t){return u=[],n&&u.push({error:"데이터베이스 오류 발생"}),t&&u.push({error:"같은 이름의 사용자가 존재합니다."}),u.length?l.fulfill(u):l.fulfill({})}),l):[{error:"not match"}]}),o.registerUser(function(t){var i,r;return i=this.Promise(null),r=new n({name:t.name,login:t.login.toLowerCase(),password:f(t.password)}),r.save(function(n,t){return n?i.fulfill(["데이터베이스 오류가 발생했습니다."]):i.fulfill(t)}),i}),o.registerSuccessRedirect("/"),o.loginView("auth/login"),o.getLoginPath("/login"),o.postLoginPath("/login"),o.authenticate(function(t,i){var r,u;return r=[],u=this.Promise(),n.getUserByLogin(t.toLowerCase(),function(n,t){return(n&&r.push("데이터베이스 오류가 발생했습니다."),t||r.push("존재하지 않는 사용자 입니다."),t&&t.password!==f(i)&&r.push("비밀번호가 일치하지 않습니다."),r.length)?u.fulfill(r):u.fulfill(t)}),u}),o.loginSuccessRedirect("/")}}).call(this)